---
title: Valheim x Docker
description: Something involving Ragnarok and/or Valhalla.
date: 2016-05-01
scheduled: 2016-05-01
tags:
  - docker
  - gaming
layout: layouts/post.njk
image: /assets/img/valheim.jpg
---
[Valheim](https://store.steampowered.com/app/892970/Valheim/) is a PC game I discovered in early 2021, during that funny time when I never left my apartment (I swear I've since gone outside). Given it's budget status and no-name development studio, I was only expecting a few days, maybe a few weeks of a diversion out of it. Now, here I am writing a friggin' article about it.

The title allows players to immerse themselves in procedurally generated Scandinavian-like landscapes, defend against waves of hidden threats, or spend an hour (or four) deciding if the rug goes by the front door or in the hallway. Most enjoyably, it's the relaxing build-survive-adventure loop that keeps me and my friends coming back.

Valheim runs via a standard client-server architecture. Typically a player launches the game, starts up a new world on their machine, and give their friends the local server name and password to connect. This is easy enough, but has a number of drawbacks - foremost being that original player has to be online or keep the game running on their machine for anyone who wants to progress in the same world. I'm sure you'd like to take a nap every once in a while.

Alternatively, the game supports dedicated servers, which just means that you can serve your world (and your epic bases) independent of the game client, your machine, or even your household. 24/7 if you want. There's two options: find and pay a third-party provider to host it for you, or self-host it...can you guess which is more fun?

Enter [Docker](https://www.ibm.com/cloud/learn/docker). More contextually, the possibility of *containerizing* said servers. Combined with [docker-compose](www.google.com), it becomes almost ridiculously easy to download, configure, and launch services of any kind. There's many different ways to approach this, but I'll try to document my bare-bones approach on a Linux based OS, command line, and compose.


## Prerequisites
- Docker
- [An OS that can run Docker](https://docs.docker.com/engine/install/#supported-platforms)

That's it. That's the post. Just kidding, kind of.

You'll need to install Docker, for which given the wealth of platforms, exact instructions can vary. It's widely supported by all major operating systems and many vendors, as either a downloadable executable or package from the above link. I run my containers on a Synology NAS via SSH, which also conveniently provides a one-click package manager in their GUI. You could even run it on a [Raspberry Pi](https://dev.to/elalemanyo/how-to-install-docker-and-docker-compose-on-raspberry-pi-1mo) if you're into that sort of thing. In most cases Docker also comes with docker-compose, a YAML-based config tool I use extensively to make things even easier.

At the end of the day, if you can enter `docker` and `docker-compose` commands in your favorite terminal, you're golden. Note there may be some OS-specific nuances, like permissions or file paths, which will be dependent on your configuration. I'm most familiar with a Linux environment.

{% image "/assets/img/docker_cmd_line.jpg", "Docker Command line" %}

## Docker Image

Now, we're ready to start figuring out the server itself.

The Valheim Dedicated Server is freely available for download, independent of the game. It'll show up under Tools in a Steam library, or more relevant to *containerizing*, via a [SteamCMD](https://developer.valvesoftware.com/wiki/SteamCMD) download given an [App ID](https://steamdb.info/app/896660/). Also note that if you don't own Valheim, why not? ðŸ˜–

But for our purposes right now, we can mostly forget about that. While the binaries are freely available to spin up our own Dockerfile and create our own image, why reinvent the wheel? Fortunately, a number of awesome individuals have done the hard part already and provided images to consume, that will auto-download the server and provide additional features. Here's a few examples:
- [lloesche/valheim-server-docker](https://github.com/lloesche/valheim-server-docker)
- [mbround18/valheim-docker](https://github.com/mbround18/valheim-docker)
- [sethmachine/valheim-server-docker](https://github.com/sethmachine/valheim-server-docker)

All of the above have a similar set of base options and will get the job done. The differences come in the nitty-gritty things like backup options, update options, or webhooks. I'm a fan of lloesche's image due to the large amount of customizable environment variables and extensive documentation, and it's the one I'll be showing for the following configuration examples.

For your device doing the hosting, lloesche recommends a minimum of a [dual core system with 4 GB of RAM](https://github.com/lloesche/valheim-server-docker#system-requirements), with increasing core count and RAM requirements per additional player. A maximum of 10 players is supported by the server.

## File Structure

Before proceeding, find your favorite (or convenient) location in the filesystem. We need to create a set of empty directories and blank files similar to my structure here:
```treeview
services/
|-- valheim-server/
|   |-- backups/
|   |-- config/
|   |-- data/
|   |-- .env
|   `-- docker-compose.yml
```

`backups` will contain copies of our world created at set intervals.
`config` will contain our generated world and any admin config.
`data` will contain the downloaded server binaries.
`docker-compose.yml` will contain the Docker image reference, volumes pointing to the above three folders, and other container configuration.
`.env` (optional) will contain environment-specific variables, I also like to put secrets in here including passwords.

## Docker Compose

This is the juice.

docker-compose.yml
```yml
services:
    valheim-server:
        image: ghcr.io/lloesche/valheim-server:latest
        container_name: valheim-server
		cap_add:
		    - sys_nice
		environment:
		    PUID: ReplaceMe
		    PGID: ReplaceMe
		    TZ: America/Los_Angeles
		    SERVER_NAME: MyEpicServer
            WORLD_NAME: MyWorldName
            SERVER_PASS: 12345
		volumes:
            - ./config:/config
            - ./data:/opt/valheim
            - ./backups:/backups
		ports:
		    - 2456-2457:2456-2457/udp
        restart: unless-stopped
```

We're specifying that we're pulling the image lloesche/valheim-server from the GitHub Container Registry, naming it, providing a basic server configuration, and pointing our container volumes to the three folders previously created.

Important: PUID and PGID are specific to your environment and identify the user and group running the container.

Timezone entries from:

Of course, you'll probably want a decent password if you want to avoid the riffraff connecting to your world. The minimum is 5 characters.

{% image "/assets/img/password_spaceballs.jpg", "Spaceballs Password" %}

Otherwise...we're already 90% there to having a functional server. The last task we need to do is opening up external access to the ports we specified.

## Port Forwarding

In our compose file, we included this line '2456-2457:2456-2457/udp' in the ports section. The server requires

2456-2457

## Starting and Connecting

Steam UI
docker-compose up -d --remove-orphans

## Additional Fluff

You want more?? Discord notifications, .env files, and other shenanigans.


### Discord Webhooks

This part gets a little messy with the backslash extravaganza.

```yml
POST_SERVER_LISTENING_HOOK: 'curl -sfSL -X POST -H "Content-Type: application/json" -d "{\"username\":\"Valheim\",\"embeds\":[{\"title\":\"Start\"\"description\":\"Server Status: Ready to Connect!\",\"color\":3066993}]}" "${DISCORD_WEBHOOK}"'
PRE_SERVER_SHUTDOWN_HOOK: 'curl -sfSL -X POST -H "Content-Type: application/json" -d "{\"username\":\"Valheim\",\"embeds\":[{\"title\":\"Stop\"\"description\":\"Server Status: Shutting Down\",\"color\":15158332}]}" "${DISCORD_WEBHOOK}"'
```
```bash
DISCORD_WEBHOOK=https://discord.com/api/webhooks/{numbers}/{letters-and-numbers}
```

<!-- ![Valheim Discord](/img/valheim_discord.jpg) -->
Note I'm making use of variable substitution in the compose file, the values are populated from the .env file (which must be in the same directory).

This post is an insurance policy. Ever heard of the [Bus Factor](https://en.wikipedia.org/wiki/Bus_factor)? Needless to say, my Valheim server must keep running, the metals must be mined, and the crops must be tended. Here's a starter on setting up a self-hosted dedicated 24/7 Valheim server (with Discord notifications).

TL;DR, the benefits of self-hosting your own dedicated, containerized Valheim server:
- Can run independently of your gaming PC
- Operates in a sandboxed environment
- Customizable to your heart's content
- No need to pay for a third-party provider

## Tips and Addendum
- Your generated world seed is based on the World Name variable you set.
- Backup your world. You don't want to lose hundreds of hours of progress!
- A tip

## Room For Improvement
I'd like to come up with a more accessible way to start, stop, or restart the server than through scripts or command line.Discord commands would be perfect, but I'm not sure how to approach it yet.

## Additional Reading
Valheim Dedicated Server PDF
